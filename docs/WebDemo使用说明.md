# 央企穿透式监督知识图谱 - 交互式Web Demo

## 功能介绍

这是一个交互式的Web应用Demo，整合了两大核心功能：

### 1. ⚖️ 法律事件监测
- **功能描述**：追踪法律事件对企业及其关联方的影响路径
- **业务场景**：当某公司的法人代表涉及法律事件（如被限高），系统可以追踪风险如何传导到其控股公司、子公司以及交易对手
- **可视化**：动态展示风险传导路径，支持两跳内的关系图谱可视化

### 2. 🔄 循环交易检测
- **功能描述**：检测企业间的循环交易模式，识别可疑交易闭环
- **业务场景**：检测公司间是否存在循环交易（A→B→C→A），并计算交易金额的相似度
- **预警机制**：当金额相似度超过90%时触发高风险预警
- **可视化**：以圆形布局展示循环交易路径，清晰显示资金流向

## 技术架构

- **后端**: Flask + Nebula Graph
- **前端**: HTML + CSS + JavaScript + D3.js
- **数据库**: Nebula Graph（图数据库）
- **可视化**: D3.js力导向图

## 安装依赖

```bash
# 安装Python依赖
uv sync
```

## 配置

确保环境变量已正确设置：

```bash
export NEBULA_ADDRESS="172.18.53.63:9669"
export NEBULA_USERNAME="root"
export NEBULA_PASSWORD="nebula"
export NEBULA_SPACE="contract_1117"
```

或者在项目根目录创建 `.env` 文件：

```env
NEBULA_ADDRESS=172.18.53.63:9669
NEBULA_USERNAME=root
NEBULA_PASSWORD=nebula
NEBULA_SPACE=contract_1117
```

## 启动Demo

```bash
cd /Users/ruipu/projects/contract-graph
uv run python src/web_demo.py
```

启动成功后，访问：
```
http://localhost:5000
```

## 使用指南

### 法律事件监测模块

1. **加载人员列表**
   - 点击"加载涉及法律事件的人员"按钮
   - 系统会查询所有涉及法律事件的人员

2. **追踪风险传导**
   - 在人员列表中点击任意人员
   - 系统自动追踪该人员的风险传导路径
   - 显示路径详情和影响范围

3. **查看可视化图谱**
   - 图谱自动展示所有风险传导路径
   - 不同颜色代表不同类型的节点：
     - 🔵 蓝色：人员节点
     - 🟣 紫色：公司节点
     - 🟢 绿色：合同节点
     - 🔴 红色：法律事件节点

4. **图谱操作**
   - 🔍 放大/缩小：使用按钮或鼠标滚轮
   - 🖱️ 拖动：鼠标拖动画布或节点
   - ↺ 重置：恢复初始视图

### 循环交易检测模块

1. **设置检测参数**
   - 调整相似度阈值（默认90%）
   - 阈值越高，检测越严格

2. **开始检测**
   - 点击"开始检测"按钮
   - 系统自动扫描图谱中的循环交易模式

3. **查看检测结果**
   - 左侧显示所有检测到的循环交易
   - 点击任意循环查看详细信息
   - 右侧显示循环的详细信息和预警级别

4. **理解可视化**
   - 圆形布局展示循环路径
   - 箭头显示交易方向
   - 标签显示交易金额
   - 节点编号表示交易顺序

## 数据说明

### 节点类型
- **Person**: 人员节点（80个）
- **Company**: 公司节点（92个）
- **Contract**: 合同节点（102个）
- **LegalEvent**: 法律事件节点（22个）
- **Transaction**: 交易节点（60个）

### 关系类型
- **LEGAL_PERSON**: 法人代表关系（人员→公司）
- **CONTROLS**: 控股关系（公司→公司）
- **PARTY_A/B**: 合同签署关系（公司→合同）
- **TRADES_WITH**: 交易关系（公司→公司）
- **INVOLVED_IN**: 涉及法律事件（人员→法律事件）
- **RELATED_TO**: 关联合同（合同→法律事件）
- **IS_SUPPLIER**: 供应商关系（公司→公司）
- **IS_CUSTOMER**: 客户关系（公司→公司）
- **PAYS/RECEIVES**: 交易支付关系（公司→交易→公司）

## API接口

### 法律事件监测

#### 获取涉及法律事件的人员
```
GET /api/legal-events/persons
```

响应示例：
```json
{
  "persons": [
    {
      "person_id": "USER_001",
      "person_name": "张伟",
      "event_id": "CASE_001",
      "event_name": "合同纠纷案件-1",
      "event_type": "Case",
      "event_status": "F"
    }
  ]
}
```

#### 追踪风险传导路径
```
GET /api/legal-events/trace/<person_id>
```

### 循环交易检测

#### 检测循环交易
```
GET /api/circular-trades/detect?threshold=90&max_depth=5
```

参数：
- `threshold`: 相似度阈值（默认90）
- `max_depth`: 最大搜索深度（默认5）

#### 获取节点邻居
```
GET /api/graph/neighbors/<node_id>
```

返回指定节点两跳内的所有邻居节点和边。

## 注意事项

1. **性能优化**
   - 大规模数据集可能影响查询性能
   - 建议限制返回结果数量
   - 循环交易检测会限制搜索深度

2. **浏览器兼容性**
   - 推荐使用Chrome、Firefox、Safari等现代浏览器
   - 需要支持ES6和SVG

3. **数据更新**
   - 确保Nebula Graph中的数据已正确导入
   - 使用 `src/nebula_import.py` 导入最新数据

## 故障排查

### 无法连接Nebula Graph
```
检查：
1. Nebula服务是否运行
2. 网络连接是否正常
3. 配置信息是否正确
```

### 查询无结果
```
检查：
1. 图空间中是否有数据
2. 数据是否正确导入
3. 查询条件是否正确
```

### 图谱无法显示
```
检查：
1. 浏览器控制台是否有错误
2. D3.js是否正确加载
3. 数据格式是否正确
```

## 扩展功能

未来可以添加的功能：
- 导出风险报告（PDF/Excel）
- 实时监控和预警通知
- 更多维度的风险分析
- 自定义查询和过滤条件
- 历史数据对比分析
- 多图空间切换

## 技术支持

如有问题，请查看：
- 项目文档：`docs/`目录
- 测试脚本：`tests/`目录
- 源代码：`src/`目录

