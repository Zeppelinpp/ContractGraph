# 分析场景说明文档

本文档简要说明知识图谱系统支持的高级分析场景。

## 场景一：FraudRank 欺诈风险传导分析

### 功能描述
基于 PageRank 算法，计算企业的欺诈风险传导分数。通过分析企业间的关联关系（控股、法人、交易、合同等），识别风险从高风险企业向关联企业传导的模式。

### 核心指标
- **初始风险分数**：基于法律事件（案件、争议）计算
  - 事件类型权重：案件(0.8)、争议(0.5)
  - 金额权重：归一化到 0-1（1000万为上限）
  - 状态权重：已立案(0.9)、一审(0.8)、执行(0.7)、已结案(0.4)
- **边权重**：不同关系类型的风险传导权重
  - CONTROLS: 0.8
  - LEGAL_PERSON: 0.75
  - PAYS: 0.65
  - RECEIVES: 0.60
  - TRADES_WITH: 0.50
- **风险等级**：高风险(≥0.7)、中风险(≥0.4)、低风险(≥0.2)、正常(<0.2)

### 输出结果
- 报告文件：`reports/fraud_rank_report.csv`
- 包含字段：公司ID、公司名称、风险分数、风险等级、法人代表、信用代码

---

## 场景二：高级循环交易检测（分散-汇聚模式）

### 功能描述
检测复杂的循环交易模式，识别资金从核心公司分散到多个公司，再通过关联关系汇聚回核心公司或其关联公司的可疑模式。

### 核心指标
- **分散节点数量**：资金分散到的公司数量
- **流入流出相似度**：流入金额与流出金额的相似度（≥70%为可疑）
- **时间窗口**：默认 180 天
- **金额阈值**：默认 50 万以上
- **风险分数**：
  - 金额相似度权重：40%
  - 分散节点数量权重：30%
  - 中间交易密度权重：30%

### 输出结果
- 报告文件：`reports/circular_trade_detection_report.csv`
- 包含字段：核心公司、分散节点、流出金额、流入金额、相似度、风险分数、时间跨度

---

## 场景三：空壳公司网络识别

### 功能描述
识别具有空壳公司特征的企业网络。通过分析资金穿透率、交易速度、交易对手多样性、法人关联等特征，识别可疑的空壳公司及其网络。

### 核心指标
- **资金穿透率**：流入流出资金的最小值/最大值（≥0.9 高嫌疑）
- **交易速度**：平均交易时间间隔（<7 天 高嫌疑）
- **交易对手多样性**：交易对手数量/总交易数（<0.2 高嫌疑）
- **法人关联公司数量**：共享法人的公司数量（≥5 高嫌疑）
- **合同数量与金额**：合同数量少但金额大（高嫌疑）
- **空壳公司分数**：综合以上特征计算（≥0.6 为高嫌疑）

### 输出结果
- 报告文件：`reports/shell_company_detection_report.csv`
- 包含字段：公司ID、公司名称、空壳分数、资金穿透率、交易速度、交易对手多样性、法人关联公司数量等
- 额外分析：识别共享法人的空壳公司网络

---

## 场景四：关联方串通网络分析

### 功能描述
检测关联方串通网络，识别包括轮流中标、围标等可疑行为模式。通过分析共享法人、控股关系构建关联网络，检测串通行为特征。

### 核心指标
- **轮换分数**：检测是否存在规律的轮流中标（完美轮换=1.0）
- **金额相似度**：合同金额的变异系数（CV越小相似度越高）
- **卡阈值比例**：合同金额刻意卡在审批阈值附近的比例
- **网络密度**：关联关系的紧密程度
- **风险分数**：
  - 轮换分数权重：30%
  - 金额相似度权重：20%
  - 卡阈值比例权重：20%
  - 网络密度权重：20%
  - 关联强度权重：10%

### 输出结果
- 报告文件：`reports/collusion_network_report.csv`
- 包含字段：网络ID、公司数量、风险分数、轮换分数、金额相似度、卡阈值比例、网络密度、合同总数、涉及金额、公司列表

---

## 场景五：履约关联风险检测

### 功能描述
根据相对方获取签署履约状态的合同存在收款逾期或交货逾期的情况，排查并列出同一相对方或存在相关关系的相对方的相同标的名称的其他合同，识别潜在的履约风险。

### 核心指标
- **逾期类型**：收款逾期、交货逾期、收款逾期+交货逾期
- **逾期天数**：当前日期与到期日期的差值
- **关联相对方**：通过 TRADES_WITH、IS_SUPPLIER、IS_CUSTOMER、CONTROLS 关系识别
- **风险分数**：
  - 逾期交易数量及严重程度：最高 50%
  - 风险合同比例：30%
  - 风险合同总金额：20%

### 输出结果
- 报告文件：`reports/perform_risk_report.csv`
- 包含字段：公司ID、公司名称、风险分数、逾期交易数、风险合同数、法人代表、信用代码、风险合同列表

---

## 场景六：外部风险事件分析【新增】

### 功能描述
整合 DaaS 外部数据中的行政处罚、经营异常等风险事件，分析这些风险事件对企业及其关联方的影响。

### 数据来源
- **AdminPenalty（行政处罚）**：来自工商、证监、市场监管等部门的行政处罚记录
- **BusinessAbnormal（经营异常）**：企业经营异常名录，包括未年报、地址异常等

### 核心指标
- **行政处罚**：
  - 处罚次数
  - 处罚金额
  - 处罚类型（证监局处罚、市场监管处罚等）
  - 处罚时间
- **经营异常**：
  - 异常次数
  - 列入原因（未年报、地址异常、信息隐瞒等）
  - 是否已移出
  - 异常持续时间

### 风险传导路径
```
AdminPenalty/BusinessAbnormal → Company → CONTROLS → Company
                              → Company → TRADES_WITH → Company
                              → Company → IS_SUPPLIER → Company
```

### 应用场景
1. **供应商风险评估**：评估供应商是否有行政处罚或经营异常记录
2. **客户风险评估**：评估客户的信用状况
3. **关联方风险传导**：分析风险事件如何通过控股、交易关系传导

---

## 场景七：人员任职网络分析【新增】

### 功能描述
分析人员在多家公司的任职情况，识别通过共同任职人员形成的关联方网络。

### 数据来源
- **EMPLOYED_BY 边**：记录人员在公司的任职关系
  - 职位（position）：董事长、总经理、监事、财务总监等
  - 任职开始时间（tenure_start）

### 核心指标
- **交叉任职**：同一人员在多家公司任职
- **高管重叠**：多家公司共享相同高管
- **任职时间重叠**：在同一时期在多家公司任职

### 风险识别
1. **关联交易识别**：共同高管的公司之间的交易
2. **利益冲突检测**：在竞争对手公司同时任职
3. **空壳公司网络**：通过任职关系识别空壳公司网络

### 分析路径
```
Person → EMPLOYED_BY → Company A
Person → EMPLOYED_BY → Company B
→ Company A 和 Company B 形成关联方关系
```

---

## 运行方式

### 单独运行
```bash
# FraudRank 分析
uv run python -m src.analysis.fraud_rank

# 循环交易检测
uv run python -m src.analysis.circular_trade

# 空壳公司识别
uv run python -m src.analysis.shell_company

# 串通网络分析
uv run python -m src.analysis.collusion

# 履约风险检测
uv run python -m src.analysis.perform_risk
```

### 批量运行
```bash
# 运行前4个场景（fraud_rank, circular_trade, shell_company, collusion）
uv run python -m src.analysis.run_all_analysis

# 履约风险检测需要单独运行（需要指定当前日期参数）
uv run python -m src.analysis.perform_risk
```

---

## 报告输出位置

所有分析报告均保存在 `reports/` 目录下：
- `fraud_rank_report.csv` - 欺诈风险传导分析报告
- `circular_trade_detection_report.csv` - 循环交易检测报告
- `shell_company_detection_report.csv` - 空壳公司识别报告
- `collusion_network_report.csv` - 串通网络分析报告
- `perform_risk_report.csv` - 履约风险检测报告

---

## 图谱数据支持

### 节点类型（7种）
| 节点类型 | 数量 | 说明 |
|---------|------|------|
| Person | 165 | 人员 |
| Company | 114 | 公司 |
| Contract | 100 | 合同 |
| LegalEvent | 20 | 法律事件 |
| Transaction | 60 | 交易 |
| AdminPenalty | 12 | 行政处罚【新增】 |
| BusinessAbnormal | 27 | 经营异常【新增】 |

### 边类型（17种）
| 边类型 | 数量 | 说明 |
|--------|------|------|
| LEGAL_PERSON | 90 | 法人代表 |
| CONTROLS | 15 | 控股 |
| PARTY_A/B/C/D | 200 | 合同参与方 |
| TRADES_WITH | 200 | 交易 |
| IS_SUPPLIER | 43 | 供应商 |
| IS_CUSTOMER | 73 | 客户 |
| PAYS | 60 | 支付 |
| RECEIVES | 60 | 收款 |
| INVOLVED_IN | 10 | 涉及事件 |
| RELATED_TO | 20 | 关联事件 |
| HAS_PARTY | 200 | 合同参与方反向 |
| EMPLOYED_BY | 80 | 雇佣【新增】 |
| ADMIN_PENALTY_OF | 12 | 行政处罚【新增】 |
| BUSINESS_ABNORMAL_OF | 26 | 经营异常【新增】 |
