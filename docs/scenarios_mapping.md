# 场景功能支持情况

## 场景概述

| 原技术名称 | 建议业务化命名 | Key | 释义 | 完成状态 | 实现模块 |
| ------------ | ----------- | ------------------------- | --------------------------------------- | -------- | -------- |
| 履约关联风险 | 逾期链式损失风险 | Overdue-Chain Loss Risk | 对方一旦逾期，同一批"标的"合同可能集体违约，导致公司连环受损。 | ✅ 已支持 | `perform_risk.py` |
| 履约能力风险 | 高风险舆情聚合风险 | Negative-Cluster Risk | 司法、行政、舆情等多维负面信号命中，触发"聚合预警"，合同履约概率快速下降。 | ✅ 已支持 | `external_risk_rank.py` |
| 法务风险分析 | 诉讼传染风险 | Lit-Contagion Risk | 只要关联公司或个人被诉，风险会沿股权、法人、交易边"传染"到本公司合同。 | ✅ 已支持 | `fraud_rank.py` |
| 义务履约风险评估 | 违约金敞口风险 | Penalty-Exposure Risk | 合同已到期却仍未完结，一旦触发违约金条款，公司将面临大额敞口。 | ⏳ 待完成 | 需要补充合同违约金额字段 |
| 相对方信用超额风险 | 集中授信爆雷风险 | Credit-Concentration Risk | 同一控制人/电话背后隐藏多家"马甲"公司，集中授信超过限额，随时集体爆雷。 | ⏳ 待完成 | 需要DAAS数据支持 |
| 循环交易检测 | 虚假贸易自融风险 | Circular-Trade Risk | 资金先转出再原路回流，构造虚假贸易背景，实质为自融或套取银行授信。 | ✅ 已支持 | `circular_trade.py` |
| 关联方串通网络分析 | 围标串标风险 | Bid-Rigging Network Risk | 多家关联公司轮流中标、金额雷同且卡审批阈值，涉嫌围标串标，导致采购成本虚高。 | ✅ 已支持 | `collusion.py` |

> 📖 详细技术实现请参考 [风险分析场景技术实现文档](./risk_analysis_implementation.md)

---

## 详细实现逻辑

一、履约关联风险（逾期链式损失风险）
实现逻辑：
- [x] 1. 查找逾期交易 (已支持✅)
  - 查询所有交易和关联的合同、相对方
  - 判断逾期：
    - 收款逾期：到期日 < 当前日期 且 总金额 > 已付金额
    - 交货逾期：到期日 < 当前日期 且 履约状态 ≠ "C"（已完成）
  - 跳过已完成（状态为 "C"）的交易
- [x] 2. 查找关联相对方
  - 通过 TRADES_WITH、IS_SUPPLIER、IS_CUSTOMER、CONTROLS 关系扩展关联相对方集合
- [x] 3. 查找风险合同
  - 从逾期交易中提取标的名称（如“建材采购合同-公司名” → “建材采购合同”）
  - 找出相同标的名称的合同
  - 仅保留来自相同或关联相对方的合同
- [x] 4. 计算风险分数
  风险分数（0-1）由三部分构成：
  1. 逾期交易基础分（最高 0.5）
      - 基础权重 0.15 × 逾期数量
      - 严重度系数：基于最长逾期天数，使用 (max_overdue_days / 365.0) ^ 0.7
      - 严重度倍数：1.0 ~ 1.5
  2. 风险合同比例分（最高 0.3）
      - 有逾期的风险合同数 / 总风险合同数 × 0.3
  3. 风险合同金额分（最高 0.2）
      - 总金额 / 1000万（归一化）× 0.2
- [x] 5. 按风险分数排序返回
返回样例:
![](@attachment/Clipboard_2025-11-24-18-49-14.png)

二、履约能力风险（高风险舆情聚合风险）(已支持✅)
- [x] 1. 基于外部风险事件的风险评分
  - 从行政处罚（AdminPenalty）计算初始风险分数
  - 从经营异常（BusinessAbnormal）计算初始风险分数
  - 考虑金额、状态、严重程度三个维度
  - 直接将风险分配给关联公司
- [x] 2. 风险传导分析
  - 通过 External Risk Rank 算法将风险沿企业关系网络传导
  - 使用不同边权重（控股 0.85、交易 0.5、供应商 0.45 等）模拟传导强度
- [x] 3. 多维度风险聚合
  - 支持仅分析行政处罚（--risk-type admin_penalty）
  - 支持仅分析经营异常（--risk-type business_abnormal）
  - 支持全部外部风险聚合（--risk-type all）

三、法务风险分析（诉讼传染风险）(已支持✅)
- [x] 1. 基于法律事件的风险评分
  - 从法律事件（案件、争议）计算初始风险分数
  - 考虑事件类型、金额、状态三个维度
  - 将风险分配给关联合同的甲乙方公司
- [x] 2. 风险传导分析
  - 通过 FraudRank 算法将风险沿企业关系网络传导
  - 使用不同边权重（控股 0.8、法人 0.75、交易 0.5 等）模拟传导强度
- [x] 3. 风险传导路径追踪
  - 追踪人员法律事件对其担任法人的公司的影响
  - 追踪到子公司、合同、交易对手
  - 生成完整的风险传导路径图

四、义务履约风险评估（违约金敞口风险）(待完成，合同数据缺乏违约金额)
- [ ] 计算存在履约未完成的合同风险系数  Fi=Ai * Bi * Ci，并根据风险系数的值判断风险等级
Ai：标的金额
Bi：违约期限
Ci：违约金金额 

五、相对方信用超额风险分析（集中授信爆雷风险）(待完成，依赖于DAAS数据)
- [ ] 根据合同的相对方，获取外部工商信息识别相同联系电话的其他相对方，汇总统计信用余额，判断是否超过了单一相对方的信用额度控制。

六、循环交易检测（虚假贸易自融风险）(已支持✅)
实现逻辑：
- [x] 1. 识别分散-汇聚模式
  - 检测资金从核心公司分散到多个公司后回流（金额阈值：50万以上，时间窗口：180天）
- [x] 2. 检测资金回流
  - 查找资金是否汇聚回核心公司或其关联公司（共同法人、控股关系）
- [x] 3. 计算风险分数
  - 流入流出金额相似度 >= 70% 为可疑
  - 风险分数：金额相似度40% + 分散节点数量30% + 中间交易密度30%
- [x] 4. 生成可疑模式报告
  - 按风险分数排序输出核心公司、分散节点、流入流出金额、相似度等信息

七、关联方串通网络分析（围标串标风险）(已支持✅)
实现逻辑：
- [x] 1. 识别关联公司集群
  - 识别共享法人或存在控股关系的公司（最小集群：3家公司）
- [x] 2. 分析串通行为模式
  - 轮换分数：检测是否存在规律的轮流中标
  - 金额相似度：合同金额的变异系数
  - 卡阈值比例：合同金额刻意卡在审批阈值附近的比例（阈值：100万、300万、500万、1000万）
  - 网络密度：集群内关联关系的紧密程度
- [x] 3. 计算风险分数
  - 风险分数：轮换分数30% + 金额相似度20% + 卡阈值比例20% + 网络密度20% + 关联强度10%
  - 风险分数 >= 0.5 标记为可疑
- [x] 4. 生成串通网络报告
  - 按风险分数排序输出网络ID、公司数量、风险分数、合同总数、涉及金额等信息


