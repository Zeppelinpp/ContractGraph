# 知识图谱高级分析场景使用说明

## 概述

本文档说明如何使用四个高级分析场景的脚本，包括：
1. FraudRank 欺诈风险传导分析
2. 高级循环交易检测（分散-汇聚模式）
3. 空壳公司网络识别
4. 关联方串通网络分析

## 前置条件

1. 已安装依赖：
```bash
uv sync
```

2. 已导入数据到 Nebula Graph：
```bash
uv run python src/nebula_import.py
```

3. 已生成增强的 mock 数据（可选，用于更好的演示效果）：
```bash
uv run python src/scripts/generate_advanced_scenario_data.py
```

## 快速开始

### 方式一：运行所有分析（推荐）

一键运行所有四个场景的分析：

```bash
uv run python src/analysis/run_all_analysis.py
```

**输出**：
- 所有分析结果将显示在控制台
- 分析报告保存在 `reports/` 目录
- 总耗时约 0.5-1 秒

### 方式二：单独运行某个场景

#### 场景一：FraudRank 欺诈风险传导分析

```bash
uv run python src/analysis/fraud_rank.py
```

**功能**：
- 识别涉及法律事件的高风险公司
- 计算风险传导路径和分数
- 基于 PageRank 算法

**输出文件**：`reports/fraud_rank_report.csv`

**报告字段**：
- 公司ID
- 公司名称
- 风险分数（0-1）
- 风险等级（高风险/中风险/低风险/正常）
- 法人代表
- 信用代码

#### 场景二：高级循环交易检测

```bash
uv run python src/analysis/circular_trade.py
```

**功能**：
- 检测分散-汇聚模式的循环交易
- 识别资金快速流转的可疑模式
- 计算流入流出金额相似度

**输出文件**：`reports/circular_trade_detection_report.csv`

**报告字段**：
- 核心公司
- 分散节点列表
- 关联节点列表
- 流出金额
- 流入金额
- 相似度
- 中间交易数
- 时间跨度（天）
- 风险分数

#### 场景三：空壳公司网络识别

```bash
uv run python src/analysis/shell_company.py
```

**功能**：
- 识别具有空壳公司特征的企业
- 分析资金穿透率、交易速度、交易对手多样性
- 识别共享法人的空壳公司网络

**输出文件**：`reports/shell_company_detection_report.csv`

**报告字段**：
- 公司ID
- 公司名称
- 空壳分数（0-1）
- 资金穿透率
- 交易速度（天）
- 交易对手多样性
- 总交易数
- 流入/流出金额
- 法人公司数量
- 合同数量

**特征说明**：
- **穿透率高**（>0.9）：资金快速流入又快速流出
- **交易速度快**（<7天）：资金周转速度异常快
- **对手单一**（<0.3）：只与少数几个公司交易
- **法人关联多**（>=3）：同一法人控制多家公司

#### 场景四：关联方串通网络分析

```bash
uv run python src/analysis/collusion.py
```

**功能**：
- 检测关联方串通网络
- 识别轮流中标模式
- 检测合同金额卡阈值现象

**输出文件**：`reports/collusion_network_report.csv`

**报告字段**：
- 网络ID
- 公司数量
- 风险分数
- 轮换分数（0-1，越高越可疑）
- 金额相似度
- 卡阈值比例
- 网络密度
- 合同总数
- 涉及金额
- 公司列表

**风险特征**：
- **轮换分数高**（>0.8）：多家公司轮流中标，分布均匀
- **金额相似**：合同金额接近，变异系数小
- **卡阈值**：合同金额刻意控制在审批阈值以下（如95万、295万）
- **网络密集**：公司间存在紧密的法人/控股关系

## 分析结果解读

### 风险等级划分

#### FraudRank 分数
- **高风险**：>= 0.7
- **中风险**：0.4 - 0.7
- **低风险**：0.2 - 0.4
- **正常**：< 0.2

#### 循环交易风险分数
- **高风险**：>= 0.7（相似度>80%，多个分散节点）
- **中风险**：0.5 - 0.7
- **关注**：0.3 - 0.5

#### 空壳公司分数
- **高嫌疑**：>= 0.6
- **中嫌疑**：0.4 - 0.6
- **低嫌疑**：< 0.4

#### 串通网络风险分数
- **高风险**：>= 0.6（轮换分数>0.8，卡阈值比例>40%）
- **中风险**：0.4 - 0.6
- **关注**：< 0.4

## 实际应用场景

### 场景一应用：合同审批流程

```python
# 伪代码示例
def approve_contract(contract_id, party_b_id):
    # 查询乙方的 FraudRank 分数
    fraud_score = get_fraud_rank_score(party_b_id)
    
    if fraud_score >= 0.7:
        return "需集团高层审批 + 现场尽调"
    elif fraud_score >= 0.4:
        return "需部门领导审批 + 额外担保"
    else:
        return "常规流程"
```

### 场景二应用：异常交易监控

```python
# 定期运行循环交易检测
def daily_circular_trade_check():
    patterns = detect_circular_trade()
    
    for pattern in patterns:
        if pattern['risk_score'] >= 0.7:
            send_alert_email(pattern)
            freeze_suspicious_transactions(pattern)
```

### 场景三应用：供应商准入

```python
# 供应商准入评估
def evaluate_supplier(supplier_id):
    shell_score = get_shell_company_score(supplier_id)
    
    if shell_score >= 0.6:
        return "拒绝准入"
    elif shell_score >= 0.4:
        return "限额合作 + 加强监控"
    else:
        return "准入"
```

### 场景四应用：招投标审核

```python
# 招投标关联方检查
def check_bid_collusion(bidders):
    networks = detect_collusion_network()
    
    for network in networks:
        bidders_in_network = set(bidders) & set(network['companies'])
        
        if len(bidders_in_network) >= 2:
            return f"警告：发现 {len(bidders_in_network)} 家关联投标方"
    
    return "通过"
```

## 参数调整

### FraudRank 参数

在 `fraud_rank.py` 中：

```python
fraud_scores = compute_fraud_rank(
    graph, 
    init_scores, 
    damping=0.85,      # 阻尼系数，建议 0.8-0.9
    max_iter=100,      # 最大迭代次数
    tolerance=1e-6     # 收敛阈值
)
```

### 循环交易检测参数

在 `circular_trade.py` 中：

```python
suspicious_patterns = detect_fan_out_fan_in(
    GRAPH_DIR,
    time_window_days=180,    # 时间窗口（天），建议 90-180
    amount_threshold=500000   # 金额阈值（元），建议 50万-100万
)
```

### 空壳公司识别参数

在 `shell_company.py` 的 `calculate_shell_company_score` 函数中调整各特征权重：

```python
# 穿透率权重：0.25
# 交易速度权重：0.20
# 对手多样性权重：0.20
# 法人公司数权重：0.20
# 合同集中度权重：0.15
```

### 串通网络检测参数

在 `collusion.py` 中：

```python
suspicious_networks = detect_collusion_network(
    GRAPH_DIR, 
    min_cluster_size=3    # 最小集群大小，建议 2-5
)
```

## 性能优化

### 大规模数据处理

如果公司数量超过 1000 家，建议：

1. 使用并行处理：
```python
from multiprocessing import Pool

with Pool(processes=4) as pool:
    results = pool.map(extract_features, company_ids)
```

2. 分批处理：
```python
batch_size = 100
for i in range(0, len(companies), batch_size):
    batch = companies[i:i+batch_size]
    process_batch(batch)
```

3. 缓存中间结果：
```python
import pickle

# 保存图数据
with open('graph_cache.pkl', 'wb') as f:
    pickle.dump(graph, f)

# 加载图数据
with open('graph_cache.pkl', 'rb') as f:
    graph = pickle.load(f)
```

## 定时任务设置

### 使用 cron（Linux/Mac）

```bash
# 编辑 crontab
crontab -e

# 每天凌晨 2 点运行分析
0 2 * * * cd /path/to/contract-graph && uv run python src/analysis/run_all_analysis.py >> /var/log/graph_analysis.log 2>&1
```

### 使用 systemd timer（Linux）

创建 `/etc/systemd/system/graph-analysis.service`：

```ini
[Unit]
Description=Knowledge Graph Analysis

[Service]
Type=oneshot
WorkingDirectory=/path/to/contract-graph
ExecStart=/usr/bin/uv run python src/analysis/run_all_analysis.py
```

创建 `/etc/systemd/system/graph-analysis.timer`：

```ini
[Unit]
Description=Run Graph Analysis Daily

[Timer]
OnCalendar=daily
OnCalendar=02:00
Persistent=true

[Install]
WantedBy=timers.target
```

启用定时器：
```bash
sudo systemctl enable graph-analysis.timer
sudo systemctl start graph-analysis.timer
```

## 常见问题

### Q1: 为什么某些公司的风险分数为 0？

A: 这些公司可能：
- 没有涉及法律事件
- 没有与高风险公司有直接或间接关联
- 在图中是孤立节点

### Q2: 如何调整风险等级阈值？

A: 修改各脚本中的 `get_risk_level` 函数或风险分数计算逻辑。

### Q3: 分析耗时太长怎么办？

A: 
1. 减少分析的公司数量（只分析重点公司）
2. 使用并行处理
3. 缓存中间结果
4. 优化 Nebula Graph 查询

### Q4: 如何集成到现有系统？

A: 
1. 将分析脚本封装为 REST API（使用 Flask/FastAPI）
2. 定期运行并将结果存入数据库
3. 开发前端界面展示分析结果

## 技术支持

如有问题，请查看：
- [知识图谱高级分析场景实施方案](./知识图谱高级分析场景实施方案.md) - 详细算法原理
- [场景数据支持分析报告](./场景数据支持分析报告.md) - 数据支持情况
- [graph_schema.md](./graph_schema.md) - 图谱结构设计

## 版本历史

- **v1.0** (2025-11-18)
  - 初始版本
  - 实现四个核心分析场景
  - 支持 CSV 报告导出

